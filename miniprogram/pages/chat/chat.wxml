<view class="container">
  <!-- 1. å¤´éƒ¨ -->
  <view class="custom-header" style="padding-top:{{statusBarHeight}}px; height:44px;">
    <view class="header-row">
      <!-- ä¿®æ”¹ï¼šæ›´ Q çš„è¿”å›æŒ‰é’® -->
      <view class="back-btn-q" bindtap="goBack">
        <view class="arrow-icon"></view>
      </view>
      <view class="header-title">{{title}}</view>
    </view>
  </view>

  <!-- 2. æ¶ˆæ¯åˆ—è¡¨ -->
  <scroll-view 
    scroll-y 
    class="chat-scroll" 
    scroll-into-view="{{scrollId}}"
    style="padding-top: {{statusBarHeight + 44 + 20}}px; padding-bottom: calc({{inputBottom}}px + {{showMore ? '300rpx' : '0rpx'}} + 120rpx + env(safe-area-inset-bottom));"
    bindtap="closeMore"
  >
    <block wx:for="{{messages}}" wx:key="_id">
      <view class="msg-container {{item.isMe ? 'align-right' : 'align-left'}}" id="msg-{{index}}">
        
        <view class="msg-row {{item.isMe ? 'my-msg' : 'other-msg'}}">
          <image class="avatar" src="{{item.avatar}}"></image>
          
          <!-- æ–‡æœ¬ -->
          <view class="bubble" wx:if="{{!item.msgType || item.msgType=='text'}}">
            <text>{{item.content}}</text>
          </view>

          <!-- å›¾ç‰‡ -->
          <image 
            wx:if="{{item.msgType=='image'}}" 
            src="{{item.content}}" 
            mode="widthFix" 
            class="msg-img"
            catchtap="previewImage" 
            data-src="{{item.content}}"
          ></image>

          <!-- å®šä½ -->
          <view 
             wx:if="{{item.msgType=='location'}}" 
             class="msg-loc" 
             catchtap="openLocation" 
             data-loc="{{item.location}}"
          >
             <view class="loc-name">{{item.location.name}}</view>
             <view class="loc-addr">{{item.location.address}}</view>
             <view class="loc-map-placeholder">ğŸ—ºï¸ åœ°å›¾ä½ç½®</view>
          </view>
        </view>

        <view class="status-row" wx:if="{{item.isMe}}">
           <text class="read-txt {{item.readStatusText=='æœªè¯»'?'un':''}}">{{item.readStatusText}}</text>
        </view>

      </view>
    </block>
    <view id="bottom-pad" style="height: 20rpx;"></view>
  </scroll-view>

  <!-- 3. è¾“å…¥åŒºåŸŸ -->
  <view class="input-area" style="bottom: {{inputBottom}}px; padding-bottom: calc({{showMore ? '300rpx' : '20rpx'}} + env(safe-area-inset-bottom))">
    <view class="more-btn" bindtap="toggleMore">+</view>
    
    <input 
      class="msg-input" 
      value="{{inputVal}}" 
      bindinput="onInput" 
      placeholder="å‘é€æ¶ˆæ¯..." 
      confirm-type="send" 
      bindconfirm="send"
      adjust-position="{{false}}" 
      bindfocus="onFocus"
      bindblur="onBlur"
    />
    <button class="send-btn" bindtap="send">å‘é€</button>
  </view>

  <!-- 4. æ›´å¤šåŠŸèƒ½é¢æ¿ -->
  <view class="more-panel" wx:if="{{showMore}}">
     <view class="panel-item" bindtap="sendImage">
        <view class="p-icon">ğŸ–¼ï¸</view>
        <text>ç…§ç‰‡</text>
     </view>
     <view class="panel-item" bindtap="sendLocation">
        <view class="p-icon">ğŸ“</view>
        <text>ä½ç½®</text>
     </view>
  </view>
</view>