<view class="container">
  <!-- 1. å¤´éƒ¨ï¼šæ ‡é¢˜ + æˆå‘˜å¤´åƒ -->
  <view class="custom-header" style="padding-top:{{statusBarHeight}}px;">
    <view class="header-row">
      <view class="back-btn-q" bindtap="goBack">
        <view class="arrow-icon"></view>
      </view>
      <view class="header-center">
        <view class="header-title">{{title}}</view>
        <!-- ç¾¤æˆå‘˜å°å¤´åƒ -->
        <view class="header-members">
           <image wx:for="{{headerAvatars}}" wx:key="*this" src="{{item}}" class="tiny-avt"></image>
        </view>
      </view>
    </view>
  </view>

  <!-- 2. æ¶ˆæ¯åˆ—è¡¨ -->
  <scroll-view 
    scroll-y 
    class="chat-scroll" 
    scroll-into-view="{{scrollId}}"
    style="padding-top: {{statusBarHeight + 60 + 20}}px; padding-bottom: calc({{inputBottom}}px + {{showMore ? '300rpx' : '0rpx'}} + 120rpx + env(safe-area-inset-bottom));"
    bindtap="closeMore"
  >
    <block wx:for="{{messages}}" wx:key="_id">
      <view class="msg-container {{item.isMe ? 'align-right' : 'align-left'}}" id="msg-{{index}}">
        
        <view class="status-row" wx:if="{{item.showTime}}">
           <text class="time-txt">{{item.timeStr}}</text>
        </view>

        <view class="msg-row {{item.isMe ? 'my-msg' : 'other-msg'}}">
          <image class="avatar" src="{{item.avatar}}" catchtap="viewProfile" data-uid="{{item.senderId}}"></image>
          
          <view class="msg-col">
             <!-- æ–°å¢ï¼šæ˜¾ç¤ºæ˜µç§° (ä»…å¯¹æ–¹æ¶ˆæ¯æ˜¾ç¤º) -->
             <text class="nickname" wx:if="{{!item.isMe}}">{{item.nickName}}</text>
             
             <!-- æ–‡æœ¬ -->
             <view class="bubble" wx:if="{{!item.msgType || item.msgType=='text'}}">
               <text>{{item.content}}</text>
             </view>

             <!-- å›¾ç‰‡ -->
             <image wx:if="{{item.msgType=='image'}}" src="{{item.content}}" mode="widthFix" class="msg-img" catchtap="previewImage" data-src="{{item.content}}"></image>

             <!-- å®šä½ -->
             <view wx:if="{{item.msgType=='location'}}" class="msg-loc" catchtap="openLocation" data-loc="{{item.content}}">
                <view class="loc-name">{{item.content.name}}</view>
                <view class="loc-addr">{{item.content.address}}</view>
                <view class="loc-map-placeholder">ğŸ—ºï¸ åœ°å›¾ä½ç½®</view>
             </view>

             <!-- è”ç³»æ–¹å¼ -->
             <view wx:if="{{item.msgType=='contact_req'}}" class="msg-card req">
                <view class="card-title">ğŸ‘‹ äº¤æ¢è”ç³»æ–¹å¼</view>
                <view class="card-desc">{{item.content}}</view>
                <button wx:if="{{!item.isMe}}" class="card-btn" catchtap="handleAcceptContact">åŒæ„å¹¶å‘é€</button>
                <view wx:else class="card-tip">ç­‰å¾…å¯¹æ–¹åŒæ„...</view>
             </view>

             <view wx:if="{{item.msgType=='contact_info'}}" class="msg-card info">
                <view class="card-title">ğŸ‘¤ è”ç³»åç‰‡</view>
                <view class="card-row">
                   <text class="c-label">{{item.content.type}}</text>
                   <text class="c-val" selectable>{{item.content.value}}</text>
                </view>
                <view class="card-tip">é•¿æŒ‰å·ç å¯å¤åˆ¶</view>
             </view>
          </view>
        </view>

        <view class="status-row" wx:if="{{item.isMe}}">
           <text class="read-txt {{item.readStatusText=='æœªè¯»'?'un':''}}">{{item.readStatusText}}</text>
        </view>

      </view>
    </block>
    <view id="bottom-pad" style="height: 20rpx;"></view>
  </scroll-view>

  <!-- 3. è¾“å…¥åŒºåŸŸ -->
  <view class="input-area" style="bottom: {{inputBottom}}px; padding-bottom: calc({{showMore ? '300rpx' : '20rpx'}} + env(safe-area-inset-bottom))">
    <view class="more-btn-q" bindtap="toggleMore"><view class="plus-icon"></view></view>
    <input class="msg-input" value="{{inputVal}}" bindinput="onInput" placeholder="å‘é€æ¶ˆæ¯..." confirm-type="send" bindconfirm="send" adjust-position="{{false}}" bindfocus="onFocus" bindblur="onBlur"/>
    <button class="send-btn" bindtap="send">å‘é€</button>
  </view>

  <!-- 4. é¢æ¿å’Œå¼¹çª—ä¿æŒä¸å˜... -->
  <view class="more-panel" wx:if="{{showMore}}">
     <view class="panel-item" bindtap="sendImage"><view class="p-icon">ğŸ–¼ï¸</view><text>ç…§ç‰‡</text></view>
     <view class="panel-item" bindtap="sendLocation"><view class="p-icon">ğŸ“</view><text>ä½ç½®</text></view>
     <view class="panel-item" bindtap="sendContactReq"><view class="p-icon">ğŸ¤</view><text>äº¤æ¢è”ç³»</text></view>
  </view>
  <view class="modal-mask" wx:if="{{showContactModal}}">
    <view class="modal-box">
      <view class="modal-title">å‘é€æˆ‘çš„è”ç³»æ–¹å¼</view>
      <view class="input-row">
         <view class="type-sel" bindtap="switchContactType">{{contactType}} â–¾</view>
         <input class="c-input" placeholder="è¯·è¾“å…¥å·ç " bindinput="onContactInput" value="{{contactValue}}"/>
      </view>
      <view class="modal-btns">
        <button class="c-btn cancel" bindtap="closeContactModal">å–æ¶ˆ</button>
        <button class="c-btn confirm" bindtap="submitContact">å‘é€</button>
      </view>
    </view>
  </view>
</view>