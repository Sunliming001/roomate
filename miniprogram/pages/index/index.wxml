<view class="container">
  <!-- 顶部导航 -->
  <view class="header" style="padding-top:{{statusBarHeight}}px">
    <view class="row">
       <!-- 核心修复：使用原生 Picker 调用 onCityChange -->
       <picker mode="region" level="city" bindchange="onCityChange">
         <view class="city-picker">
           <text>{{currentCity}}</text>
           <text class="arrow">▾</text>
         </view>
       </picker>

       <!-- 搜索框 (点击跳出地图选点) -->
       <view class="search-box" bindtap="onSearchTap">
         <icon type="search" size="14"></icon>
         <input class="search-input" placeholder="点击搜索小区位置" value="{{searchKeyword}}" disabled="true" />
         <view wx:if="{{searchKeyword}}" catchtap="clearSearch" class="clear-icon">×</view>
       </view>
    </view>
  </view>

  <!-- 筛选栏 -->
  <view class="filters" style="top:{{statusBarHeight+44}}px">
    <picker range="{{['全部','招男生','招女生','不限']}}" bindchange="onFilterGender">
       <view class="tag {{filter.gender > 0 ? 'act' : ''}}">
         {{ filter.gender > 0 ? ['全部','招男生','招女生','不限'][filter.gender] : '期望性别' }} ▾
       </view>
    </picker>
    
    <view class="tag {{showPriceSlider?'act':''}}" bindtap="togglePriceSlider">
        {{ (priceMin > 0 || priceMax < 10000) ? (priceMin + '-' + priceMax) : '租金范围' }} ▾
    </view>
    
    <view class="tag {{filter.ensuite?'act':''}}" bindtap="toggleEnsuite">独卫</view>
  </view>

  <!-- 租金滑块弹层 -->
  <view class="slider-box" wx:if="{{showPriceSlider}}">
     <view class="slider-title">
        租金范围 (¥{{priceMin}} - ¥{{priceMax}})
        <text style="font-size:20rpx; margin-left:10rpx; color:#ccc;">(步长500)</text>
     </view>
     <view class="slider-container" id="slider-track">
        <view class="slider-track"></view>
        <view class="slider-highlight" style="left:{{leftPercent}}%; width:{{widthPercent}}%"></view>
        <view class="slider-handle" style="left:{{leftPercent}}%" catchtouchmove="onMoveMin">
           <view class="tip">¥{{priceMin}}</view>
        </view>
        <view class="slider-handle" style="left:{{rightPercent}}%" catchtouchmove="onMoveMax">
           <view class="tip">¥{{priceMax}}</view>
        </view>
     </view>
     <view class="slider-btns">
        <button class="reset-btn" size="mini" bindtap="resetPrice">重置</button>
        <button class="confirm-btn" size="mini" bindtap="confirmPrice">确定</button>
     </view>
  </view>
  <view class="mask" wx:if="{{showPriceSlider}}" bindtap="togglePriceSlider"></view>

  <view style="height:{{statusBarHeight+44+40}}px"></view>

  <!-- 瀑布流列表 (修复布局) -->
  <view class="waterfall">
    <view class="col">
      <block wx:for="{{leftList}}" wx:key="_id"><template is="card" data="{{item}}"/></block>
    </view>
    <view class="col">
      <block wx:for="{{rightList}}" wx:key="_id"><template is="card" data="{{item}}"/></block>
    </view>
  </view>
  
  <view wx:if="{{leftList.length==0 && rightList.length==0}}" class="empty-tip">当前城市暂无符合条件的房源</view>
</view>

<template name="card">
  <view class="card" bindtap="goDetail" data-id="{{item._id}}">
    <image src="{{item.cover}}" mode="aspectFill" class="cover"></image>
    <view class="info">
      <view class="tit">{{item.community}}</view>
      <view class="dots">
         <block wx:for="{{item.dots}}" wx:key="index">
            <view class="dot {{item}}"></view>
         </block>
         <text class="dist" wx:if="{{item.distStr}}">{{item.distStr}}</text>
      </view>
      <view class="btm">
         <view class="pub">
            <image class="avt" src="{{item.publisher.avatarUrl || '/images/default.png'}}"></image>
            <text class="nm">{{item.publisher.nickName}}</text>
         </view>
         <text class="fav">★ {{item.favCount||0}}</text>
      </view>
    </view>
  </view>
</template>