<view class="container">
  <!-- 顶部导航 -->
  <!-- 核心修复：row 增加 padding-right，避开胶囊按钮 -->
  <view class="header" style="padding-top:{{statusBarHeight}}px">
    <view class="row" style="padding-right: {{headerPaddingRight}}px">
       <picker mode="region" level="city" bindchange="onCityChange">
         <view class="city-picker">
           <text>{{currentCity}}</text>
           <text class="arrow">▾</text>
         </view>
       </picker>
       <view class="search-box" bindtap="onSearchTap">
         <icon type="search" size="14"></icon>
         <input class="search-input" placeholder="点击搜索小区位置" value="{{searchKeyword}}" disabled="true" />
         <!-- 确保这个 view 的 z-index 够高 -->
         <view wx:if="{{searchKeyword}}" catchtap="clearSearch" class="clear-icon">×</view>
       </view>
    </view>
  </view>

  <!-- 筛选栏 -->
  <view class="filters" style="top:{{statusBarHeight+44}}px">
    <!-- 1. 排序 -->
    <picker range="{{['最新发布','收藏最多']}}" bindchange="onSortChange">
       <view class="tag {{sortType=='hot' ? 'act' : ''}}">
         {{sortType=='hot'?'收藏最多':'最新发布'}} ▾
       </view>
    </picker>
    
    <!-- 2. 性别 -->
    <picker range="{{['全部','招男生','招女生','不限']}}" bindchange="onFilterGender">
       <view class="tag {{filter.gender > 0 ? 'act' : ''}}">
         {{ filter.gender > 0 ? ['全部','招男生','招女生','不限'][filter.gender] : '期望性别' }} ▾
       </view>
    </picker>
    
    <!-- 3. 租金 -->
    <view class="tag {{showPriceSlider?'act':''}}" bindtap="togglePriceSlider">
        {{ (priceMin > 0 || priceMax < 10000) ? (priceMin + '-' + priceMax) : '租金' }} ▾
    </view>

    <!-- 4. 宠物 -->
    <picker range="{{['不限','不接受养宠','接受养猫','接受养狗']}}" bindchange="onPetChange">
       <view class="tag {{filter.pet && filter.pet!=='不限' ? 'act' : ''}}">
         {{(!filter.pet || filter.pet === '不限') ? '宠物要求' : filter.pet}} ▾
       </view>
    </picker>
    
    <!-- 5. 独卫 -->
    <view class="tag {{filter.ensuite?'act':''}}" bindtap="toggleEnsuite">独卫</view>
  </view>

  <!-- 租金滑块弹层 -->
  <view class="slider-box" wx:if="{{showPriceSlider}}">
     <view class="slider-title">
        租金范围 (¥{{priceMin}} - ¥{{priceMax}})
        <text style="font-size:20rpx; margin-left:10rpx; color:#ccc;">(步长500)</text>
     </view>
     <view class="slider-container" id="slider-track">
        <view class="slider-track"></view>
        <view class="slider-highlight" style="left:{{leftPercent}}%; width:{{widthPercent}}%"></view>
        <view class="slider-handle" style="left:{{leftPercent}}%" catchtouchmove="onMoveMin">
           <view class="tip">¥{{priceMin}}</view>
        </view>
        <view class="slider-handle" style="left:{{rightPercent}}%" catchtouchmove="onMoveMax">
           <view class="tip">¥{{priceMax}}</view>
        </view>
     </view>
     <view class="slider-btns">
        <button class="reset-btn" size="mini" bindtap="resetPrice">重置</button>
        <button class="confirm-btn" size="mini" bindtap="confirmPrice">确定</button>
     </view>
  </view>
  <view class="mask" wx:if="{{showPriceSlider}}" bindtap="togglePriceSlider"></view>

  <view style="height:{{statusBarHeight+44+50}}px"></view>

  <!-- 列表 -->
  <view class="waterfall">
    <view class="col">
      <block wx:for="{{leftList}}" wx:key="_id"><template is="card" data="{{item}}"/></block>
    </view>
    <view class="col">
      <block wx:for="{{rightList}}" wx:key="_id"><template is="card" data="{{item}}"/></block>
    </view>
  </view>
  
  <view wx:if="{{leftList.length==0 && rightList.length==0}}" class="empty-tip">当前城市暂无符合条件的房源</view>
</view>

<template name="card">
  <view class="card" bindtap="goDetail" data-id="{{item._id}}">
    <image src="{{item.cover}}" mode="aspectFill" class="cover"></image>
    <view class="info">
      <view class="tit">{{item.community}}</view>
      <view class="dots">
         <block wx:for="{{item.dots}}" wx:key="index">
            <view class="dot {{item}}"></view>
         </block>
         <text class="dist" wx:if="{{item.distStr}}">{{item.distStr}}</text>
      </view>
      <view class="btm">
         <view class="pub">
            <image class="avt" src="{{item.publisher.avatarUrl || '/images/default.png'}}"></image>
            <text class="nm">{{item.publisher.nickName}}</text>
         </view>
         <text class="fav">★ {{item.favCount||0}}</text>
      </view>
    </view>
  </view>
</template>